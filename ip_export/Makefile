SHELL       :=  /bin/bash
VIVADO_VER  :=  2023.2
SRC_XIL      =  source /tools/Xilinx/Vivado/${VIVADO_VER}/settings64.sh
SIM_DIR     ?=  sim/synth/func
PYTHON      ?=  python3.11


help:
	@echo
	@echo "Help"
	@echo "  - clean"
	@echo "  - install_deps"
	@echo "  - py_codegen"
	@echo "  - py_test"
	@echo "  - compile"
	@echo "  - elaborate"
	@echo "  - simulate"
	@echo "  - waveform"
	@echo ""
	@echo "To Run a simulation for a specific configuration use:"
	@echo "  SIM_DIR=sim/synth/func make simulate (default)"
	@echo "  SIM_DIR=sim/synth/timing make simulate"
	@echo "  SIM_DIR=sim/impl/func make simulate"
	@echo "  SIM_DIR=sim/imply/timing make simulate"


clean_%: export build_type=$(shell echo "$*" | awk -F'_' '{ print $$1 }')
clean_%: export sim_type=$(shell echo "$*" | awk -F'_' '{ print $$2 }')
clean_%:
	@echo "Cleaning:"
	@echo -e "\t - Build type: ${build_type}"
	@echo -e "\t - Simulation type: ${sim_type}"
	@cd sim/${build_type}/${sim_type} && rm -rf xsim.dir *.log *.pb *.jou


clean: clean_synth_func clean_synth_timing clean_impl_func clean_impl_timing
	@echo "Cleaning"
	@rm -rf build/


install_deps:
	${PYTHON} -m pip install -r ./requirements-test.txt


py_test:
	@echo
	@echo " - Running Python Tests"
	${PYTHON} -m pytest --disable-warnings tests_filter_msg_gen.py


py_codegen:
	${PYTHON} ./filter_msg_gen.py
	mv pysv_pkg.sv ./sim
	mv ./build/libpysv.so ./sim

compile: py_codegen
	@echo "  - Compiling"
	${SRC_XIL} && cd ${SIM_DIR} && ./compile.sh

elaborate: compile
	@echo "  - Elaborating"
	${SRC_XIL} && cd ${SIM_DIR} && ./elaborate.sh

simulate: elaborate
	@echo "  - Simulating"
	${SRC_XIL} && cd ${SIM_DIR} && ./simulate.sh

waveform:
	@echo
	@echo " - Displaying waveform"
	@echo " xsim --gui ./sim/autogenerated_tb_func_synth.wdb"
	${SRC_XIL} && cd sim && \
		xsim --gui ./autogenerated_tb_func_synth.wdb \
		--view ./autogenerated_tb_func_synth.wcfg

wave: waveform


